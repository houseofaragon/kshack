"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("@babel/runtime/helpers/objectWithoutPropertiesLoose"),r=require("react"),n=require("three"),a=require("@react-three/fiber"),i=require("react-merge-refs"),o=require("../materials/MeshReflectorMaterial.cjs.js");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function l(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("@babel/runtime/helpers/createClass"),require("@babel/runtime/helpers/inheritsLoose");var s=u(e),d=u(t),c=l(r),p=u(i);a.extend({MeshReflectorMaterial:o.MeshReflectorMaterial});var f=c.forwardRef((function(e,t){var r=e.mixBlur,i=void 0===r?0:r,o=e.mixStrength,u=void 0===o?.5:o,l=e.resolution,f=void 0===l?256:l,m=e.args,h=void 0===m?[1,1]:m,x=e.minDepthThreshold,M=void 0===x?.9:x,b=e.maxDepthThreshold,g=void 0===b?1:b,v=e.depthScale,T=void 0===v?0:v,w=e.depthToBlurRatioBias,S=void 0===w?.25:w,y=e.mirror,R=e.children,j=e.debug,F=void 0===j?0:j,B=e.distortion,D=void 0===B?1:B,W=e.distortionMap,V=d.default(e,["mixBlur","mixStrength","resolution","args","minDepthThreshold","maxDepthThreshold","depthScale","depthToBlurRatioBias","mirror","children","debug","distortion","distortionMap"]),_=a.useThree((function(e){return e.gl})),E=a.useThree((function(e){return e.camera})),P=a.useThree((function(e){return e.scene})),q=c.useRef(null),O=c.useState((function(){return new n.Plane}))[0],L=c.useState((function(){return new n.Vector3}))[0],U=c.useState((function(){return new n.Vector3}))[0],k=c.useState((function(){return new n.Vector3}))[0],C=c.useState((function(){return new n.Matrix4}))[0],G=c.useState((function(){return new n.Vector3(0,0,-1)}))[0],z=c.useState((function(){return new n.Vector4}))[0],I=c.useState((function(){return new n.Vector3}))[0],A=c.useState((function(){return new n.Vector3}))[0],N=c.useState((function(){return new n.Vector4}))[0],H=c.useState((function(){return new n.Matrix4}))[0],J=c.useState((function(){return new n.PerspectiveCamera}))[0],K=c.useState((function(){for(var e=[],t={minFilter:n.LinearFilter,magFilter:n.LinearFilter,format:n.RGBFormat,encoding:_.outputEncoding},r=0;r<8;r++){var a=Math.max(8,Math.round(f/Math.pow(2,r))),i=new n.WebGLRenderTarget(a,a,t);i.texture.generateMipmaps=!1,e.push(i)}return e}))[0],Q=c.useCallback((function(){if(U.setFromMatrixPosition(q.current.matrixWorld),k.setFromMatrixPosition(E.matrixWorld),C.extractRotation(q.current.matrixWorld),L.set(0,0,1),L.applyMatrix4(C),I.subVectors(U,k),!(I.dot(L)>0)){I.reflect(L).negate(),I.add(U),C.extractRotation(E.matrixWorld),G.set(0,0,-1),G.applyMatrix4(C),G.add(k),A.subVectors(U,G),A.reflect(L).negate(),A.add(U),J.position.copy(I),J.up.set(0,1,0),J.up.applyMatrix4(C),J.up.reflect(L),J.lookAt(A),J.far=E.far,J.updateMatrixWorld(),J.projectionMatrix.copy(E.projectionMatrix),H.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),H.multiply(J.projectionMatrix),H.multiply(J.matrixWorldInverse),H.multiply(q.current.matrixWorld),O.setFromNormalAndCoplanarPoint(L,U),O.applyMatrix4(J.matrixWorldInverse),z.set(O.normal.x,O.normal.y,O.normal.z,O.constant);var e=J.projectionMatrix;N.x=(Math.sign(z.x)+e.elements[8])/e.elements[0],N.y=(Math.sign(z.y)+e.elements[9])/e.elements[5],N.z=-1,N.w=(1+e.elements[10])/e.elements[14],z.multiplyScalar(2/z.dot(N)),e.elements[2]=z.x,e.elements[6]=z.y,e.elements[10]=z.z+1,e.elements[14]=z.w}}),[E.far,E.matrixWorld,E.projectionMatrix,k,z,G,L,N,O,U,C,A,H,I,J]),X=c.useMemo((function(){var e={minFilter:n.LinearFilter,magFilter:n.LinearFilter,format:n.RGBFormat,encoding:_.outputEncoding},t=new n.WebGLRenderTarget(f,f,e);T>0&&(t.depthBuffer=!0,t.depthTexture=new n.DepthTexture(f,f),t.depthTexture.format=n.DepthFormat,t.depthTexture.type=n.UnsignedShortType);var r=K.reduce((function(e,t,r){return e["u_mipmap_"+r]=t.texture,e["u_mipmap_res_"+r]=new n.Vector2(t.width,t.height),e}),{});return[t,s.default({mirror:y,textureMatrix:H,mixBlur:i,tDiffuse:t.texture,tDepth:t.depthTexture,mixStrength:u,minDepthThreshold:M,maxDepthThreshold:g,depthScale:T,depthToBlurRatioBias:S,debug:F,distortion:D,distortionMap:W,"defines-USE_DEPTH":T>0?"":void 0,"defines-USE_DISTORTION":W?"":void 0},r)]}),[_,H,f,y,i,u,M,g,T,S,F,D,W,K]),Y=X[0],Z=X[1];return a.useFrame((function(){if(null!=q&&q.current){q.current.visible=!1;var e=_.xr.enabled,t=_.shadowMap.autoUpdate;Q(),_.xr.enabled=!1,_.shadowMap.autoUpdate=!1,_.setRenderTarget(Y),_.state.buffers.depth.setMask(!0),_.autoClear||_.clear(),_.render(P,J),0!==i&&K.forEach((function(e){_.setRenderTarget(e),_.state.buffers.depth.setMask(!0),_.render(P,J)})),_.xr.enabled=e,_.shadowMap.autoUpdate=t,q.current.visible=!0,_.setRenderTarget(null)}})),c.createElement("mesh",s.default({ref:p.default([q,t])},V),c.createElement("planeBufferGeometry",{args:h}),R?R("meshReflectorMaterial",Z):c.createElement("meshReflectorMaterial",Z))}));exports.Reflector=f;
